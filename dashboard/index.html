<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orthanc - Tower of Saruman</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Middle-earth Palette */
      --bg-dark: #1a1410;           /* Mordor black */
      --bg-card: #2d2620;           /* Dark stone */
      --bg-hover: #3d3630;          /* Stone highlight */
      --border: #4a4338;            /* Weathered stone */
      --text-primary: #e8dcc8;      /* Parchment */
      --text-secondary: #a89f8f;    /* Aged parchment */
      --text-muted: #6d6854;        /* Dark parchment */
      --gold: #d4af37;              /* Elven gold */
      --gold-dim: #664d1f;          /* Mithril shadow */
      --green: #4a7c23;             /* Shire green */
      --green-dim: #2d5016;         /* Deep Shire */
      --red: #a23b22;               /* Gondor crimson */
      --red-dim: #5d1810;           /* Dark Gondor */
      --blue: #2c5aa0;              /* Numenor blue */
      --orange: #d97706;            /* Dwarven forge */
      /* Compatibility aliases */
      --amber: var(--gold);
      --amber-dim: var(--gold-dim);
      --teal: var(--blue);
      --teal-dim: #1a3660;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Crimson Text', Georgia, 'Palatino Linotype', serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
      line-height: 1.5;
    }
    .header {
      background: linear-gradient(135deg, var(--amber-dim) 0%, var(--teal-dim) 100%);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      flex-shrink: 0;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .logo svg { width: 32px; height: 32px; color: var(--amber); }
    .logo h1 { font-size: 1.5rem; font-weight: 700; }
    .logo span { color: var(--text-secondary); font-size: 0.875rem; }
    .search-box {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      min-width: 300px;
    }
    .search-box input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 0.875rem;
      outline: none;
    }
    .search-box input::placeholder { color: var(--text-muted); }
    .status-bar {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 0.875rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }
    .status-dot.offline { background: var(--red); animation: none; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .main { display: flex; flex: 1; min-height: 0; overflow: hidden; }
    .sidebar {
      width: 200px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 1rem 0;
      flex-shrink: 0;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
    .nav-item.active {
      background: var(--bg-hover);
      color: var(--amber);
      border-left-color: var(--amber);
    }
    .nav-item svg { width: 18px; height: 18px; }
    .nav-item .badge {
      margin-left: auto;
      background: var(--amber-dim);
      color: var(--amber);
      padding: 0.125rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .content { flex: 1; padding: 1.5rem; overflow: auto; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
    }
    .stat-card .label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--amber);
      margin-top: 0.25rem;
    }
    .stat-card.teal .value { color: var(--teal); }
    .stat-card.green .value { color: var(--green); }
    .stat-card.orange .value { color: var(--orange); }
    .feed {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .feed-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .feed-header h2 { font-size: 1rem; font-weight: 600; }
    .feed-list { max-height: 600px; overflow-y: auto; }
    .feed-item {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 1rem;
      transition: background 0.15s;
    }
    .feed-item:hover { background: var(--bg-hover); }
    .feed-item:last-child { border-bottom: none; }
    .feed-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .feed-icon.task { background: var(--amber-dim); color: var(--amber); }
    .feed-icon.claim { background: var(--teal-dim); color: var(--teal); }
    .feed-icon.intent { background: var(--green-dim); color: var(--green); }
    .feed-icon.evidence { background: #1e3a5f; color: #60a5fa; }
    .feed-icon.change { background: #3f3f46; color: #a1a1aa; }
    .feed-icon.agent { background: #4c1d95; color: #a78bfa; }
    .feed-icon svg { width: 18px; height: 18px; }
    .feed-body { flex: 1; min-width: 0; }
    .feed-title {
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .feed-meta {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }
    .feed-time {
      font-size: 0.75rem;
      color: var(--text-muted);
      flex-shrink: 0;
    }
    .tag {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-right: 0.5rem;
    }
    .tag.backlog { background: var(--text-muted); color: var(--bg-dark); }
    .tag.todo { background: var(--amber-dim); color: var(--amber); }
    .tag.in_progress { background: var(--teal-dim); color: var(--teal); }
    .tag.review { background: #1e3a5f; color: #60a5fa; }
    .tag.done { background: var(--green-dim); color: var(--green); }
    .tag.cancelled { background: var(--red-dim); color: var(--red); }
    .empty-state {
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
    }
    .refresh-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8125rem;
      transition: all 0.15s;
    }
    .refresh-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tab {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.15s;
    }
    .tab:hover { background: var(--bg-hover); }
    .tab.active { background: var(--amber-dim); color: var(--amber); border-color: var(--amber-dim); }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .search-box { min-width: auto; flex: 1; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .footer {
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 1rem 2rem;
      text-align: center;
      flex-shrink: 0;
    }
    .footer-content {
      max-width: 600px;
      margin: 0 auto;
    }
    .footer-copyright {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }
    .footer-copyright a {
      color: var(--gold);
      text-decoration: none;
      transition: color 0.15s;
    }
    .footer-copyright a:hover {
      color: var(--text-primary);
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .footer-links a {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.8125rem;
      transition: color 0.15s;
    }
    .footer-links a:hover {
      color: var(--gold);
    }
    .footer-links svg {
      width: 16px;
      height: 16px;
    }
    /* Detail Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .modal-header h2 {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .modal-header .type-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .modal-header .type-badge.task { background: var(--amber-dim); color: var(--amber); }
    .modal-header .type-badge.claim { background: var(--teal-dim); color: var(--teal); }
    .modal-header .type-badge.intent { background: var(--green-dim); color: var(--green); }
    .modal-header .type-badge.evidence { background: #1e3a5f; color: #60a5fa; }
    .modal-header .type-badge.change { background: #3f3f46; color: #a1a1aa; }
    .modal-header .type-badge.agent { background: #4c1d95; color: #a78bfa; }
    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.5rem;
      font-size: 1.5rem;
      line-height: 1;
      transition: color 0.15s;
    }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body {
      padding: 1.25rem;
      overflow-y: auto;
      flex: 1;
    }
    .detail-grid {
      display: grid;
      gap: 1rem;
    }
    .detail-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 1rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .detail-value {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.8125rem;
      color: var(--text-primary);
      word-break: break-all;
    }
    .detail-value.json {
      background: var(--bg-dark);
      padding: 0.75rem;
      border-radius: 6px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .detail-value .tag { margin-right: 0.25rem; }
    .related-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    .related-section h3 {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }
    .related-item {
      padding: 0.5rem 0.75rem;
      background: var(--bg-dark);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 0.8125rem;
    }
    .related-item:hover { background: var(--bg-hover); }
    /* Compliance indicator styles */
    .compliance-section {
      margin-top: 1.5rem;
      padding: 1rem;
      background: var(--bg-dark);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .compliance-section h3 {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .compliance-score {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .compliance-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-card);
      border-radius: 4px;
      overflow: hidden;
    }
    .compliance-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .compliance-bar-fill.green { background: var(--green); }
    .compliance-bar-fill.yellow { background: var(--amber); }
    .compliance-bar-fill.red { background: var(--red); }
    .compliance-value {
      font-size: 1.25rem;
      font-weight: 600;
      min-width: 50px;
      text-align: right;
    }
    .compliance-value.green { color: var(--green); }
    .compliance-value.yellow { color: var(--amber); }
    .compliance-value.red { color: var(--red); }
    .compliance-checks {
      display: grid;
      gap: 0.5rem;
    }
    .compliance-check {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8125rem;
    }
    .compliance-check-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }
    .compliance-check-icon.pass { color: var(--green); }
    .compliance-check-icon.fail { color: var(--red); }
    .compliance-violations {
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: var(--red-dim);
      border-radius: 6px;
      font-size: 0.75rem;
      color: var(--red);
    }
    .compliance-loading {
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    .feed-item { cursor: pointer; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <circle cx="12" cy="12" r="4"/>
        <line x1="12" y1="2" x2="12" y2="6"/>
        <line x1="12" y1="18" x2="12" y2="22"/>
        <line x1="2" y1="12" x2="6" y2="12"/>
        <line x1="18" y1="12" x2="22" y2="12"/>
      </svg>
      <div>
        <h1>Orthanc</h1>
        <span>The Tower of Saruman - Multi-Agent Command</span>
      </div>
    </div>
    <div class="search-box">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" id="search" placeholder="Search tasks, agents, files...">
    </div>
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Connecting...</span>
      <span id="lastUpdate" style="color: var(--text-muted)"></span>
    </div>
  </header>

  <main class="main">
    <nav class="sidebar">
      <div class="nav-item active" data-view="feed">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/></svg>
        Live Feed
      </div>
      <div class="nav-item" data-view="tasks">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Tasks
        <span class="badge" id="taskCount">0</span>
      </div>
      <div class="nav-item" data-view="agents">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Agents
        <span class="badge" id="agentCount">0</span>
      </div>
      <div class="nav-item" data-view="claims">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        Claims
        <span class="badge" id="claimCount">0</span>
      </div>
      <div class="nav-item" data-view="changelog">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Changelog
      </div>
      <div class="nav-item" data-view="metrics">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Metrics
      </div>
    </nav>

    <section class="content" id="content">
      <!-- Dynamic content -->
    </section>
  </main>

  <footer class="footer">
    <div class="footer-content">
      <div class="footer-copyright">
        &copy; 2026 <a href="https://tylerbuilds.com" target="_blank">Tyler Casey</a> &middot;
        <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a>
      </div>
      <div class="footer-links">
        <a href="https://tylerbuilds.com" target="_blank">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
          </svg>
          tylerbuilds.com
        </a>
        <a href="https://github.com/tylerbuilds" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
          GitHub
        </a>
        <a href="https://x.com/TylerIsBuilding" target="_blank">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          @TylerIsBuilding
        </a>
      </div>
    </div>
  </footer>

  <!-- Detail Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2><span class="type-badge" id="modalType"></span><span id="modalTitle"></span></h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:4177/api'
      : `${window.location.protocol}//${window.location.hostname}:4177/api`;

    let currentView = 'feed';
    let allData = { tasks: [], agents: [], claims: [], changelog: [], intents: [], evidence: [] };
    let searchQuery = '';

    // Icons as SVG strings
    const icons = {
      task: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      claim: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
      intent: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
      evidence: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="m9 15 2 2 4-4"/></svg>',
      change: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>',
      agent: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><path d="M8 16h.01"/><path d="M16 16h.01"/></svg>'
    };

    function timeAgo(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      return `${Math.floor(seconds / 86400)}d ago`;
    }

    function formatDate(ts) {
      if (!ts) return 'N/A';
      return new Date(ts).toLocaleString();
    }

    // Format status for display
    function formatStatus(status) {
      return status.replace('_', ' ');
    }

    // Modal functions
    function showDetail(type, id) {
      let item, title;
      switch (type) {
        case 'task':
          item = allData.tasks.find(t => t.id === id);
          title = item?.title || id;
          break;
        case 'claim':
          item = allData.claims.find(c => c.agentId === id || c.filePath === id);
          title = item?.filePath || id;
          break;
        case 'intent':
          item = allData.intents.find(i => i.id === id);
          title = `Intent ${id.slice(0, 8)}...`;
          break;
        case 'evidence':
          item = allData.evidence.find(e => e.id === id);
          title = item?.command || id;
          break;
        case 'change':
          item = allData.changelog.find(c => c.id === id);
          title = item?.filePath || id;
          break;
        case 'agent':
          item = allData.agents.find(a => a.agentId === id);
          title = id;
          break;
      }
      if (!item) return;

      document.getElementById('modalType').className = `type-badge ${type}`;
      document.getElementById('modalType').textContent = type;
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = renderDetailBody(type, item);
      document.getElementById('modalOverlay').classList.add('active');

      // Load compliance data for task details
      if (type === 'task') {
        loadCompliance(item.id);
      }
    }

    async function loadCompliance(taskId) {
      const container = document.getElementById('compliance-container');
      if (!container) return;

      try {
        const response = await fetch(`/api/compliance/${taskId}`);
        if (!response.ok) throw new Error('Failed to fetch compliance');
        const data = await response.json();

        if (!data.data.agents || data.data.agents.length === 0) {
          container.innerHTML = `
            <h3>üîç Compliance</h3>
            <div class="compliance-loading">No agents have worked on this task yet.</div>
          `;
          return;
        }

        container.innerHTML = renderComplianceSection(data.data);
      } catch (err) {
        container.innerHTML = `
          <h3>üîç Compliance</h3>
          <div class="compliance-loading">Unable to load compliance data.</div>
        `;
      }
    }

    function renderComplianceSection(data) {
      const getScoreClass = (score) => {
        if (score >= 100) return 'green';
        if (score >= 70) return 'yellow';
        return 'red';
      };

      let html = `<h3>üîç Compliance ${data.allCompliant ? '‚úì' : '‚ö†'}</h3>`;

      data.agents.forEach(agent => {
        const scoreClass = getScoreClass(agent.score);
        html += `
          <div style="margin-bottom: 1rem;">
            <div style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
              Agent: <strong>${agent.agentId}</strong>
            </div>
            <div class="compliance-score">
              <div class="compliance-bar">
                <div class="compliance-bar-fill ${scoreClass}" style="width: ${agent.score}%"></div>
              </div>
              <div class="compliance-value ${scoreClass}">${agent.score}</div>
            </div>
            <div class="compliance-checks">
              ${renderCheck('Intent Posted', agent.checks.intentPosted.passed, `${agent.checks.intentPosted.count} intent(s)`)}
              ${renderCheck('Evidence Attached', agent.checks.evidenceAttached.passed, `${agent.checks.evidenceAttached.count} evidence(s)`)}
              ${renderCheck('Files Match', agent.checks.filesMatch.passed,
                agent.checks.filesMatch.passed ? 'All modifications declared' :
                `Undeclared: ${agent.checks.filesMatch.undeclared.join(', ')}`)}
              ${renderCheck('Boundaries Respected', agent.checks.boundariesRespected.passed,
                agent.checks.boundariesRespected.passed ? 'No violations' :
                `Violations: ${agent.checks.boundariesRespected.violations.join(', ')}`)}
              ${renderCheck('Claims Released', agent.checks.claimsReleased.passed,
                agent.checks.claimsReleased.passed ? 'All claims released' :
                `Active: ${agent.checks.claimsReleased.activeClaims.join(', ')}`)}
            </div>
          </div>
        `;
      });

      return html;
    }

    function renderCheck(label, passed, detail) {
      const icon = passed ? '‚úì' : '‚úó';
      const iconClass = passed ? 'pass' : 'fail';
      return `
        <div class="compliance-check">
          <span class="compliance-check-icon ${iconClass}">${icon}</span>
          <span>${label}</span>
          <span style="color: var(--text-muted); margin-left: auto; font-size: 0.75rem;">${detail}</span>
        </div>
      `;
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    // Close modal on overlay click
    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'modalOverlay') closeModal();
    });

    // Close modal on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    function renderDetailBody(type, item) {
      const rows = [];
      const addRow = (label, value, isJson = false) => {
        if (value === undefined || value === null) return;
        const displayValue = isJson
          ? `<div class="detail-value json">${JSON.stringify(value, null, 2)}</div>`
          : `<div class="detail-value">${value}</div>`;
        rows.push(`<div class="detail-row"><div class="detail-label">${label}</div>${displayValue}</div>`);
      };

      switch (type) {
        case 'task':
          addRow('ID', item.id);
          addRow('Title', item.title);
          addRow('Description', item.description || 'No description');
          addRow('Status', `<span class="tag ${item.status}">${formatStatus(item.status)}</span>`);
          addRow('Priority', item.priority);
          addRow('Assigned Agent', item.assignedAgent || 'Unassigned');
          addRow('Labels', item.labels?.length ? item.labels.map(l => `<span class="tag">${l}</span>`).join('') : 'None');
          addRow('Story Points', item.storyPoints);
          addRow('Created', formatDate(item.createdAt));
          addRow('Updated', formatDate(item.updatedAt));
          addRow('Started', formatDate(item.startedAt));
          addRow('Completed', formatDate(item.completedAt));
          // Related data
          const taskIntents = allData.intents.filter(i => i.taskId === item.id);
          const taskEvidence = allData.evidence.filter(e => e.taskId === item.id);
          if (taskIntents.length || taskEvidence.length) {
            let related = '<div class="related-section">';
            if (taskIntents.length) {
              related += `<h3>Intents (${taskIntents.length})</h3>`;
              taskIntents.forEach(i => {
                related += `<div class="related-item" onclick="showDetail('intent', '${i.id}')">${i.agentId}: ${i.files?.join(', ') || 'No files'}</div>`;
              });
            }
            if (taskEvidence.length) {
              related += `<h3>Evidence (${taskEvidence.length})</h3>`;
              taskEvidence.forEach(e => {
                related += `<div class="related-item" onclick="showDetail('evidence', '${e.id}')">${e.agentId}: ${e.command}</div>`;
              });
            }
            related += '</div>';
            rows.push(related);
          }
          // Compliance section (loaded async)
          rows.push(`<div id="compliance-container" data-task-id="${item.id}" class="compliance-section">
            <h3>üîç Compliance</h3>
            <div class="compliance-loading">Loading compliance data...</div>
          </div>`);
          break;
        case 'claim':
          addRow('Agent ID', item.agentId);
          addRow('File Path', item.filePath);
          addRow('Files', item.files, true);
          addRow('Created', formatDate(item.createdAt));
          addRow('Expires', formatDate(item.expiresAt));
          break;
        case 'intent':
          addRow('ID', item.id);
          addRow('Task ID', `<span class="related-item" onclick="showDetail('task', '${item.taskId}')" style="display:inline-block;margin:0">${item.taskId}</span>`);
          addRow('Agent ID', item.agentId);
          addRow('Files', item.files, true);
          addRow('Boundaries', item.boundaries || 'None specified');
          addRow('Acceptance Criteria', item.acceptanceCriteria || 'None specified');
          addRow('Created', formatDate(item.createdAt || item.postedAt));
          break;
        case 'evidence':
          addRow('ID', item.id);
          addRow('Task ID', `<span class="related-item" onclick="showDetail('task', '${item.taskId}')" style="display:inline-block;margin:0">${item.taskId}</span>`);
          addRow('Agent ID', item.agentId);
          addRow('Command', `<code>${item.command}</code>`);
          addRow('Output', item.output, true);
          addRow('Created', formatDate(item.createdAt));
          break;
        case 'change':
          addRow('ID', item.id);
          if (item.taskId) addRow('Task ID', `<span class="related-item" onclick="showDetail('task', '${item.taskId}')" style="display:inline-block;margin:0">${item.taskId}</span>`);
          addRow('Agent ID', item.agentId);
          addRow('File Path', item.filePath);
          addRow('Change Type', `<span class="tag">${item.changeType}</span>`);
          addRow('Summary', item.summary);
          if (item.diffSnippet) addRow('Diff', item.diffSnippet, true);
          addRow('Commit Hash', item.commitHash);
          addRow('Created', formatDate(item.createdAt));
          break;
        case 'agent':
          addRow('Agent ID', item.agentId);
          addRow('Status', `<span class="tag ${item.status === 'online' ? 'done' : 'cancelled'}">${item.status}</span>`);
          addRow('Capabilities', item.capabilities, true);
          addRow('Metadata', item.metadata, true);
          addRow('Registered', formatDate(item.registeredAt));
          addRow('Last Heartbeat', formatDate(item.lastHeartbeat));
          // Show agent's claims
          const agentClaims = allData.claims.filter(c => c.agentId === item.agentId);
          if (agentClaims.length) {
            let related = '<div class="related-section"><h3>Active Claims (' + agentClaims.length + ')</h3>';
            agentClaims.forEach(c => {
              related += `<div class="related-item" onclick="showDetail('claim', '${c.filePath}')">${c.filePath}</div>`;
            });
            related += '</div>';
            rows.push(related);
          }
          break;
      }
      addRow('Raw Data', item, true);
      return `<div class="detail-grid">${rows.join('')}</div>`;
    }

    function matchesSearch(item) {
      if (!searchQuery) return true;
      const q = searchQuery.toLowerCase();
      const searchable = JSON.stringify(item).toLowerCase();
      return searchable.includes(q);
    }

    async function fetchData() {
      try {
        const [tasksRes, agentsRes, claimsRes, changelogRes, intentsRes, evidenceRes] = await Promise.all([
          fetch(`${API_BASE}/tasks`).then(r => r.json()).catch(() => ({ tasks: [] })),
          fetch(`${API_BASE}/agents`).then(r => r.json()).catch(() => ({ agents: [] })),
          fetch(`${API_BASE}/claims`).then(r => r.json()).catch(() => ({ claims: [] })),
          fetch(`${API_BASE}/changelog?limit=100`).then(r => r.json()).catch(() => ({ entries: [] })),
          fetch(`${API_BASE}/intents`).then(r => r.json()).catch(() => ({ intents: [] })),
          fetch(`${API_BASE}/evidence`).then(r => r.json()).catch(() => ({ evidence: [] }))
        ]);

        // API returns { ok: true, data: ... } - extract data, handle both array and object responses
        allData = {
          tasks: Array.isArray(tasksRes.data) ? tasksRes.data : (tasksRes.data?.tasks || tasksRes.tasks || []),
          agents: agentsRes.data?.agents || agentsRes.agents || [],
          claims: claimsRes.data?.claims || claimsRes.claims || [],
          changelog: changelogRes.data?.entries || changelogRes.entries || [],
          intents: Array.isArray(intentsRes.data) ? intentsRes.data : (intentsRes.data?.intents || intentsRes.intents || []),
          evidence: Array.isArray(evidenceRes.data) ? evidenceRes.data : (evidenceRes.data?.evidence || evidenceRes.evidence || [])
        };

        document.getElementById('statusDot').classList.remove('offline');
        document.getElementById('statusText').textContent = 'Connected';
        document.getElementById('lastUpdate').textContent = `Updated ${new Date().toLocaleTimeString()}`;

        updateCounts();
        render();
      } catch (e) {
        document.getElementById('statusDot').classList.add('offline');
        document.getElementById('statusText').textContent = 'Offline';
        console.error('Fetch error:', e);
      }
    }

    function updateCounts() {
      document.getElementById('taskCount').textContent = allData.tasks.filter(t => t.status !== 'done' && t.status !== 'cancelled').length;
      document.getElementById('agentCount').textContent = allData.agents.filter(a => a.status === 'online').length;
      document.getElementById('claimCount').textContent = allData.claims.length;
    }

    function render() {
      const content = document.getElementById('content');
      switch (currentView) {
        case 'feed': content.innerHTML = renderFeed(); break;
        case 'tasks': content.innerHTML = renderTasks(); break;
        case 'agents': content.innerHTML = renderAgents(); break;
        case 'claims': content.innerHTML = renderClaims(); break;
        case 'changelog': content.innerHTML = renderChangelog(); break;
        case 'metrics': content.innerHTML = renderMetrics(); break;
      }
    }

    function renderFeed() {
      // Combine all events into timeline
      const events = [];

      allData.tasks.forEach(t => events.push({ type: 'task', data: t, time: t.updatedAt || t.createdAt }));
      allData.claims.forEach(c => events.push({ type: 'claim', data: c, time: c.createdAt }));
      allData.intents.forEach(i => events.push({ type: 'intent', data: i, time: i.postedAt }));
      allData.evidence.forEach(e => events.push({ type: 'evidence', data: e, time: e.createdAt }));
      allData.changelog.forEach(c => events.push({ type: 'change', data: c, time: c.createdAt }));

      events.sort((a, b) => new Date(b.time) - new Date(a.time));
      const filtered = events.filter(e => matchesSearch(e.data)).slice(0, 50);

      if (filtered.length === 0) {
        return `<div class="feed"><div class="empty-state">No activity yet. Start coordinating!</div></div>`;
      }

      const items = filtered.map(e => {
        let title, meta, itemId;
        switch (e.type) {
          case 'task':
            title = e.data.title;
            meta = `<span class="tag ${e.data.status}">${formatStatus(e.data.status)}</span>${e.data.assignedAgent || 'Unassigned'}`;
            itemId = e.data.id;
            break;
          case 'claim':
            title = e.data.filePath;
            meta = `Claimed by ${e.data.agentId}`;
            itemId = e.data.filePath;
            break;
          case 'intent':
            title = `Intent for task ${e.data.taskId}`;
            meta = `${e.data.agentId} - ${(e.data.files || []).length} files`;
            itemId = e.data.id;
            break;
          case 'evidence':
            title = `Evidence: ${e.data.command}`;
            meta = `Task ${e.data.taskId} by ${e.data.agentId}`;
            itemId = e.data.id;
            break;
          case 'change':
            title = `${e.data.changeType}: ${e.data.filePath}`;
            meta = `${e.data.agentId} - ${e.data.summary || ''}`;
            itemId = e.data.id;
            break;
        }
        return `
          <div class="feed-item" onclick="showDetail('${e.type}', '${itemId}')">
            <div class="feed-icon ${e.type}">${icons[e.type]}</div>
            <div class="feed-body">
              <div class="feed-title">${title}</div>
              <div class="feed-meta">${meta}</div>
            </div>
            <div class="feed-time">${timeAgo(e.time)}</div>
          </div>
        `;
      }).join('');

      return `
        <div class="stats-grid">
          <div class="stat-card"><div class="label">In Progress</div><div class="value">${allData.tasks.filter(t => t.status === 'in_progress').length}</div></div>
          <div class="stat-card teal"><div class="label">Active Claims</div><div class="value">${allData.claims.length}</div></div>
          <div class="stat-card green"><div class="label">Online Agents</div><div class="value">${allData.agents.filter(a => a.status === 'online').length}</div></div>
          <div class="stat-card orange"><div class="label">In Review</div><div class="value">${allData.tasks.filter(t => t.status === 'review').length}</div></div>
        </div>
        <div class="feed">
          <div class="feed-header">
            <h2>Activity Feed</h2>
            <button class="refresh-btn" onclick="fetchData()">Refresh</button>
          </div>
          <div class="feed-list">${items}</div>
        </div>
      `;
    }

    function renderTasks() {
      const statuses = ['backlog', 'todo', 'in_progress', 'review', 'done'];
      const filtered = allData.tasks.filter(matchesSearch);

      const columns = statuses.map(status => {
        const tasks = filtered.filter(t => t.status === status);
        const items = tasks.map(t => `
          <div class="feed-item" onclick="showDetail('task', '${t.id}')">
            <div class="feed-icon task">${icons.task}</div>
            <div class="feed-body">
              <div class="feed-title">${t.title}</div>
              <div class="feed-meta">${t.assignedAgent || 'Unassigned'} - P${t.priority || 3}</div>
            </div>
            <div class="feed-time">${timeAgo(t.updatedAt || t.createdAt)}</div>
          </div>
        `).join('') || '<div class="empty-state" style="padding:1rem">No tasks</div>';

        return `
          <div class="feed" style="flex:1;min-width:280px">
            <div class="feed-header">
              <h2><span class="tag ${status}">${formatStatus(status)}</span> ${tasks.length}</h2>
            </div>
            <div class="feed-list" style="max-height:500px">${items}</div>
          </div>
        `;
      }).join('');

      return `<div style="display:flex;gap:1rem;overflow-x:auto">${columns}</div>`;
    }

    function renderAgents() {
      const filtered = allData.agents.filter(matchesSearch);
      if (filtered.length === 0) {
        return `<div class="feed"><div class="empty-state">No agents registered</div></div>`;
      }

      const items = filtered.map(a => `
        <div class="feed-item" onclick="showDetail('agent', '${a.agentId}')">
          <div class="feed-icon agent">${icons.agent}</div>
          <div class="feed-body">
            <div class="feed-title">${a.agentId}</div>
            <div class="feed-meta">
              <span class="tag ${a.status === 'online' ? 'done' : 'cancelled'}">${a.status}</span>
              ${a.capabilities?.join(', ') || 'No capabilities'}
            </div>
          </div>
          <div class="feed-time">${a.lastHeartbeat ? timeAgo(a.lastHeartbeat) : 'Never'}</div>
        </div>
      `).join('');

      return `
        <div class="feed">
          <div class="feed-header"><h2>Registered Agents</h2></div>
          <div class="feed-list">${items}</div>
        </div>
      `;
    }

    function renderClaims() {
      const filtered = allData.claims.filter(matchesSearch);
      if (filtered.length === 0) {
        return `<div class="feed"><div class="empty-state">No active claims</div></div>`;
      }

      const items = filtered.map(c => `
        <div class="feed-item" onclick="showDetail('claim', '${c.filePath}')">
          <div class="feed-icon claim">${icons.claim}</div>
          <div class="feed-body">
            <div class="feed-title">${c.filePath}</div>
            <div class="feed-meta">${c.agentId} - Expires ${timeAgo(c.expiresAt)}</div>
          </div>
          <div class="feed-time">${timeAgo(c.createdAt)}</div>
        </div>
      `).join('');

      return `
        <div class="feed">
          <div class="feed-header"><h2>Active File Claims</h2></div>
          <div class="feed-list">${items}</div>
        </div>
      `;
    }

    function renderChangelog() {
      const filtered = allData.changelog.filter(matchesSearch);
      if (filtered.length === 0) {
        return `<div class="feed"><div class="empty-state">No changes logged</div></div>`;
      }

      const items = filtered.map(c => `
        <div class="feed-item" onclick="showDetail('change', '${c.id}')">
          <div class="feed-icon change">${icons.change}</div>
          <div class="feed-body">
            <div class="feed-title">${c.changeType}: ${c.filePath}</div>
            <div class="feed-meta">${c.agentId} - ${c.summary || 'No summary'}</div>
          </div>
          <div class="feed-time">${timeAgo(c.createdAt)}</div>
        </div>
      `).join('');

      return `
        <div class="feed">
          <div class="feed-header"><h2>Change Log</h2></div>
          <div class="feed-list">${items}</div>
        </div>
      `;
    }

    function renderMetrics() {
      const done = allData.tasks.filter(t => t.status === 'done');
      const inProgress = allData.tasks.filter(t => t.status === 'in_progress');
      const total = allData.tasks.length;
      const completion = total ? Math.round((done.length / total) * 100) : 0;

      // Time-based statistics
      const now = Date.now();
      const DAY = 86400000;
      const tasksLast24h = allData.tasks.filter(t => (t.createdAt || 0) > now - DAY).length;
      const tasksLast7d = allData.tasks.filter(t => (t.createdAt || 0) > now - 7 * DAY).length;
      const tasksLast30d = allData.tasks.filter(t => (t.createdAt || 0) > now - 30 * DAY).length;
      const tasksLast365d = allData.tasks.filter(t => (t.createdAt || 0) > now - 365 * DAY).length;

      const completedLast24h = allData.tasks.filter(t => (t.completedAt || 0) > now - DAY).length;
      const completedLast7d = allData.tasks.filter(t => (t.completedAt || 0) > now - 7 * DAY).length;
      const completedLast30d = allData.tasks.filter(t => (t.completedAt || 0) > now - 30 * DAY).length;

      const changesLast24h = allData.changelog.filter(c => (c.createdAt || 0) > now - DAY).length;
      const changesLast7d = allData.changelog.filter(c => (c.createdAt || 0) > now - 7 * DAY).length;

      return `
        <div class="stats-grid">
          <div class="stat-card"><div class="label">Total Tasks</div><div class="value">${total}</div></div>
          <div class="stat-card green"><div class="label">Completed</div><div class="value">${done.length}</div></div>
          <div class="stat-card teal"><div class="label">In Progress</div><div class="value">${inProgress.length}</div></div>
          <div class="stat-card orange"><div class="label">Completion Rate</div><div class="value">${completion}%</div></div>
        </div>
        <div class="feed">
          <div class="feed-header"><h2>Activity Timeline</h2></div>
          <div style="padding:1.5rem">
            <table style="width:100%;border-collapse:collapse;font-size:0.875rem">
              <thead>
                <tr style="text-align:left;color:var(--text-muted);border-bottom:1px solid var(--border)">
                  <th style="padding:0.75rem 1rem">Period</th>
                  <th style="padding:0.75rem 1rem;text-align:center">Tasks Created</th>
                  <th style="padding:0.75rem 1rem;text-align:center">Tasks Completed</th>
                  <th style="padding:0.75rem 1rem;text-align:center">Changes Made</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom:1px solid var(--border)">
                  <td style="padding:0.75rem 1rem;color:var(--gold)">Last 24 Hours</td>
                  <td style="padding:0.75rem 1rem;text-align:center;font-weight:600">${tasksLast24h}</td>
                  <td style="padding:0.75rem 1rem;text-align:center;color:var(--green);font-weight:600">${completedLast24h}</td>
                  <td style="padding:0.75rem 1rem;text-align:center">${changesLast24h}</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border)">
                  <td style="padding:0.75rem 1rem;color:var(--gold)">Last 7 Days</td>
                  <td style="padding:0.75rem 1rem;text-align:center;font-weight:600">${tasksLast7d}</td>
                  <td style="padding:0.75rem 1rem;text-align:center;color:var(--green);font-weight:600">${completedLast7d}</td>
                  <td style="padding:0.75rem 1rem;text-align:center">${changesLast7d}</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border)">
                  <td style="padding:0.75rem 1rem;color:var(--gold)">Last 30 Days</td>
                  <td style="padding:0.75rem 1rem;text-align:center;font-weight:600">${tasksLast30d}</td>
                  <td style="padding:0.75rem 1rem;text-align:center;color:var(--green);font-weight:600">${completedLast30d}</td>
                  <td style="padding:0.75rem 1rem;text-align:center">-</td>
                </tr>
                <tr>
                  <td style="padding:0.75rem 1rem;color:var(--gold)">Last 365 Days</td>
                  <td style="padding:0.75rem 1rem;text-align:center;font-weight:600">${tasksLast365d}</td>
                  <td style="padding:0.75rem 1rem;text-align:center;color:var(--green);font-weight:600">${done.length}</td>
                  <td style="padding:0.75rem 1rem;text-align:center">${allData.changelog.length}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="label">Total Evidence</div><div class="value">${allData.evidence.length}</div></div>
          <div class="stat-card teal"><div class="label">Total Intents</div><div class="value">${allData.intents.length}</div></div>
          <div class="stat-card green"><div class="label">Changelog Entries</div><div class="value">${allData.changelog.length}</div></div>
          <div class="stat-card orange"><div class="label">Agents Seen</div><div class="value">${allData.agents.length}</div></div>
        </div>
        <div class="feed">
          <div class="feed-header"><h2>Task Distribution</h2></div>
          <div style="padding:1.5rem;display:flex;gap:1rem;flex-wrap:wrap">
            ${['backlog','todo','in_progress','review','done','cancelled'].map(s => {
              const count = allData.tasks.filter(t => t.status === s).length;
              return `<div><span class="tag ${s}">${formatStatus(s)}</span> ${count}</div>`;
            }).join('')}
          </div>
        </div>
      `;
    }

    // Event handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        currentView = item.dataset.view;
        render();
      });
    });

    document.getElementById('search').addEventListener('input', (e) => {
      searchQuery = e.target.value;
      render();
    });

    // Initial load and auto-refresh
    fetchData();
    setInterval(fetchData, 5000);
  </script>
</body>
</html>
